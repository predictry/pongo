(function() {
    var isPredictObjExists = false;

    function isPredictObjExistsCallback(x) {
        if (!isPredictObjExists) {
            isPredictObjExists = (typeof predict === 'object') ? true : false;
            if (isPredictObjExists) {
                fetchRecomendation();
            }
        }
    }

    function fetchRecomendation() {

        if (!predict.is_lookup_widget)
        {
            predict.predictry_nodes = document.querySelectorAll(".predictry");
            console.log(predict.predictry_nodes);

            [].forEach.call(predict.predictry_nodes, function(elem) {
                var i = 0, ds = elem.dataset;

                if (ds.predictryWidgetId === undefined || ds.predictryWidgetId === "")
                    return;

                if (ds.predictryCallback === undefined) {
                    _predictry.push(['getRecommendedItems', {item_id: ds.predictryItemId, user_id: ds.predictryUserId, widget_id: ds.predictryWidgetId}, function(response) {
                            if (i === 0) {
                                if (response !== undefined && typeof response === 'object') {
                                    predict.widgets.push({widget_id: ds.predictryWidgetId, response: response.data.items});
                                    _predictry.push(['drawList', elem, response]);
                                }
                                i++;
                                console.log("done getRecommendedItems");
                            }
                        }
                    ]);
                }
                else
                    _predictry.push(['getRecommendedItems', data, ds.predictryCallback]);

            });

            predict.is_lookup_widget = true;
        }

    }

//try to check if the predict object already available for 5 times (1.5s, 3s, 4.5s, 6s);
    for (var i = 0; i < 5; i++) {
        setTimeout(function(x) {
            return function() {
                isPredictObjExistsCallback(x);
            };
        }(i), 1500 * i);
    }
})();
